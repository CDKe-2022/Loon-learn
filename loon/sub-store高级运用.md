### 节点去复用与按照真实落地IP重命名节点（sub-store高级应用）  
  
更新时间：2023-07-25 16:02  

原作者网址：[可莉news](https://getupnote.com/share/notes/zSn1ShBmzNYISKcTgjXE5oHMrNf2/5937e5fe-85f7-48bf-95a0-f9ed56365810)  

## 特别注意： 

1.此教程所使用的脚本仅针对境外节点编写，国内节点不在考虑范围内，也不接受此类反馈；

2.此教程所使用的脚本仅适用于Loon和Surge，其他软件无法使用；

3.此教程所使用的Sub-Store插件属于Loon专用版，其他软件无法使用，除此之外，其他功能一切正常；
  
4.iOS 15以下的用户慎用，由于iOS 15之前的系统，其NetworkExtension框架的内存限制只有15MB可用，强行运行此脚本会导致Loon被系统断开；
 
5.部分机场的落地判断可能会因为机场的落地服务器跨国跳IP导致判断结果和实际测试有所出入，这是正常的；

6.节点的质量如果太差可能会被当做无效节点剔除掉，具体详见timeout和cd参数说明；

7.节点的延时测试请求可能会被机场劫持到入口服务器，导致测得的延时是你到国内入口服务器之间的延时，这并不是真实的节点延时。建议使用地址路径不含generate_204路径的测试地址，可以尝试使用境外CDN较为丰富且未被墙地址http://www.bing.com或者http://1.1.1.1；

8.脚本会将处理后的节点信息缓存在Sub-Store里以供二次调用，提高运行效率。默认的缓存有效期为48小时，可以进入Sub-Store插件的配置界面自定义缓存有效期；

9.上传至Gist的订阅没有流量信息，本地订阅可以输出流量信息，但如果订阅的获取时间超过15秒则会订阅失败；

10.部分机场可能对User-Agent有要求，如果下载到的订阅没有节点或者节点数量明显不对，以及节点下载失败的，可以在Sub-Store的订阅添加界面更换UA尝试。  


## 准备工作：
1.你需要拥有一个**GitHub**账号，然后前往此处学习**GitHub个人访问令牌**[申请教程](https://getupnote.com/share/notes/zSn1ShBmzNYISKcTgjXE5oHMrNf2/d34d4ea0-258f-4d58-88d9-04438a05f576)；  

2.必须删除你正在使用的Sub-Store插件并安装Loon的**专属Sub-Store缓存版**插件；  

3.确保Loon的配置能正常工作，且已经安装了**证书**；  

4.确保**MitM**、**脚本**和**复写**功能已经打开；  

5.确保你的节点订阅有效；  

6.建议在**Safari浏览器**中浏览此[教程](https://getupnote.com/share/notes/zSn1ShBmzNYISKcTgjXE5oHMrNf2/5937e5fe-85f7-48bf-95a0-f9ed56365810)。  

****
## 教程开始：
- 在Safari种**打开Sub-Store**的页面；  

- 在**我的**页面→点击**编辑**→填写**GitHub账号**和申请到的**个人访问令牌**→点击**保存**；  

- 在订阅页面选择右下角的添加按钮→点击单条订阅→在名称处输入唯一的英文标识名称（此名称将用于生成订阅链接使用）→在显示名称处输入订阅名称（此名称将在Sub-Store页面上显示订阅名称）→在来源处选择远程订阅→在链接处填写你的节点订阅链接→滑动到最底部→点击添加一个操作→选择脚本操作→点击确认→类型选择链接→在内容处输入
```
https://gitlab.com/lodepuly/vpn_tool/-/raw/main/Resource/Script/Sub-Store/NodeRename.js#bs=10&timeout=2000&cd=&2000&iisp&flag&city&fgf=→&name=[方括号内填写你的机场名称]&tz=[方括号内填写你的机场名称]
```
→点击保存；  

- 在同步页面选择右下角的添加按钮→在名称处输入唯一的英文标识名称（此名称将用于生成订阅链接使用）→在显示名称处输入订阅名称（此名称将在Sub-Store页面上显示订阅名称）→在来源处选择单条订阅→选择目标平台为Loon→点击确定→左滑刚刚创建的同步配置→选择图中被框选的☁图标上传处理后的订阅到Gist，当看到页面提示同步成功即可；  


- 在同步页面点击刚刚创建的同步配置右上角的被框选的复制按钮以获取上传到Gist上的订阅链接；  

- 将生成的Gist订阅链接添加到Loon的节点订阅里即可使用，处理后的节点效果如下图。  


## 参数示例：
> https://gitlab.com/lodepuly/vpn_tool/-/raw/main/Resource/Script/Sub-Store/NodeRename.js#bs=10&timeout=2000&cd=&2000&iisp&flag&city&fgf=→&name=[方括号内填写你的机场名称]&tz=[方括号内填写你的机场名称]

## 符号说明：
🅳电信

🅻联通

🆈移动

🅶广电

🅲公司

🆉直连

🎮游戏

## 参数说明：
以下是此脚本支持的参数，必须以#开头，多个参数使用&连接，参考上面的参数示例使用参数；

无参数时的节点命名格式为美国 01，如果入口IP或国家或落地IP或国家一样则为命名格式为直连 德国 01；
## 入口参数
**[iisp]**        增加入口运营商或者直连标识；

**[city]**      增加入口城市文字标识；

**[sheng]**     增加入口省份文字标识；

**[yuan]**      为境外入口添加真实的入口属地标识，当未配置此此参数时，则将境外入口统一标记为[境外]，默认未配置此参数；

## 落地参数
**[yisp]**      显示落地详细运营商名称；

**[yw]**        落地归属地使用英文缩写标识，不建议与其他入口参数配合使用，因为其他参数API没有返回英文；

## 图标参数
**[game]**      增加游戏节点标识；

**[flag]**      增加国家或地区的旗帜标识，默认无此参数；

**[bl]**        保留倍率标识；

**[snone]**     清理某地区内只有一个节点的序号；

## 分隔符参数
**[fgf=]**      设置入口和落地之间的分隔符，默认为空格；

**[sn=]**       设置国家与序号之间的分隔符，默认为空格；

**[name=]**     为节点添加机场名称前缀；

## 通知参数
**[offtz]**     关闭脚本通知；

**[tz=]**       为推送通知时添加机场名称；

## 解析参数
**[dnsjx]**     将节点域名解析为IP，普通用户不建议使用；

## 逻辑参数
[bs=]       批处理节点数建议10个左右，如果经常读不到节点建议减小批处理个数；

## 缓存参数
**[h=]**        节点缓存有效期，单位小时，时间参数只能二选一，Loon用户不需填写要此参数，请进入Sub-Store插件的配置界面自定义缓存有效期；

**[min=]**      节点缓存有效期，单位分钟，时间参数只能二选一，Loon用户不需填写要此参数，请进入Sub-Store插件的配置界面自定义缓存有效期；

## 超时参数
**[timeout=]**  当无任何节点缓存时测试节点HTTP延时允许的最大超时参数，超出允许范围则判定为无效节点，默认2000ms；

**[cd=]**       当有缓存时，会先读取缓存，且对节点进行延时测试，直接输出结果；

            当无缓存时，会对节点直接进行HTTP延时测试，默认460ms。节点延时超过所设定的值时会再次重试，累计两次，若再次超时则会判定为无效节点，并将结果写入缓存；
            当设置[cd=]的值小于50时，则直接读取缓存；

## 其他参数
**[debug]**     调试日志，普通用户不建议使用。
